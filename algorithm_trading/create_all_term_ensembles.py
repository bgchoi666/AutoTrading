# Copyright 2021 Bimghi Choi. All Rights Reserved.

# -*- coding:utf-8 -*-

# 주어진 구간에서 train된 모델들에 대한 앙상블들을 생성하여 각각의 수익률과 함께 저장

import tensorflow as tf
from tensorflow import keras

import ensemble_test as ep
import datetime
import pandas as pd
import numpy as np
import sys
import random

ep.selected_num = 3
ep.weights = [1 for i in range(ep.selected_num)]

last_trains = [
    '2016-12-31',

    '2017-01-15', '2017-01-31', '2017-02-15', '2017-02-28',
    '2017-03-15', '2017-03-31', '2017-04-15', '2017-04-30',
    '2017-05-15', '2017-05-31', '2017-06-15', '2017-06-30',
    '2017-07-15', '2017-07-31', '2017-08-15', '2017-08-31',
    '2017-09-15', '2017-09-30', '2017-10-15', '2017-10-31',
    '2017-11-15', '2017-11-30', '2017-12-15',

    '2017-12-31',

    '2018-01-15', '2018-01-31', '2018-02-15', '2018-02-28',
    '2018-03-15', '2018-03-31', '2018-04-15', '2018-04-30',
    '2018-05-15', '2018-05-31', '2018-06-15', '2018-06-30',
    '2018-07-15', '2018-07-31', '2018-08-15', '2018-08-31',
    '2018-09-15', '2018-09-30', '2018-10-15', '2018-10-31',
    '2018-11-15', '2018-11-30', '2018-12-15',

    '2018-12-31',
    '2019-01-15', '2019-01-31', '2019-02-15', '2019-02-28',
    '2019-03-15', '2019-03-31', '2019-04-15', '2019-04-30',
    '2019-05-15', '2019-05-31', '2019-06-15', '2019-06-30',
    '2019-07-15', '2019-07-31', '2019-08-15', '2019-08-31',
    '2019-09-15', '2019-09-30', '2019-10-15', '2019-10-31',
    '2019-11-15', '2019-11-30', '2019-12-15',

    '2019-12-31',
    '2020-01-15', '2020-01-31', '2020-02-15', '2020-02-28',
    '2020-03-15', '2020-03-31', '2020-04-15', '2020-04-30',
    '2020-05-15', '2020-05-31', '2020-06-15', '2020-06-30',
    '2020-07-15', '2020-07-31', '2020-08-15', '2020-08-31',
    '2020-09-15', '2020-09-30', '2020-10-15', '2020-10-31',
    '2020-11-15', '2020-11-30', '2020-12-15',

    '2020-12-31',
    '2021-01-15', '2021-01-31', '2021-02-15', '2021-02-28',
    '2021-03-15', '2021-03-31', '2021-04-15', '2021-04-30',
    '2021-05-15', '2021-05-31', '2021-06-15', '2021-06-30',
    '2021-07-15', '2021-07-31', '2021-08-15', '2021-08-31',
    '2021-09-15', '2021-09-30', '2021-10-15', '2021-10-31',
    '2021-11-15', '2021-11-30', '2021-12-15',

    '2021-12-31',
    '2022-01-15', '2022-01-31', '2022-02-15', '2022-02-28',
    '2022-03-15', '2022-03-31', '2022-04-15', 

    '2022-04-30',
    '2022-05-15', '2022-05-31', '2022-06-15', '2022-06-30',
    '2022-07-15', '2022-07-31', '2022-08-15', '2022-08-31',
    '2022-09-15', '2022-09-30', '2022-10-15', '2022-10-31',
    '2022-11-15', '2022-11-30', '2022-12-15', 

    '2022-12-31',
    '2023-01-15', '2023-01-31', '2023-02-15', '2023-02-28',
    '2023-03-15', '2023-03-31', '2023-04-15', '2023-04-30',
    '2023-05-15', '2023-05-31', '2023-06-15', '2023-06-30',
    '2023-07-15', '2023-07-31', '2023-08-15', '2023-08-31',
    '2023-09-15', '2023-09-30', '2023-10-15', '2023-10-31',
    '2023-11-15', '2023-11-30', '2023-12-15',
]


start_times = [
    '2017/01/01/09:00', '2017/01/16/09:00', '2017/02/01/09:00', '2017/02/16/09:00',
    '2017/03/01/09:00', '2017/03/16/09:00', '2017/04/01/09:00', '2017/04/16/09:00',
    '2017/05/01/09:00', '2017/05/16/09:00', '2017/06/01/09:00', '2017/06/16/09:00',
    '2017/07/01/09:00', '2017/07/16/09:00', '2017/08/01/09:00', '2017/08/16/09:00',
    '2017/09/01/09:00', '2017/09/16/09:00', '2017/10/01/09:00', '2017/10/16/09:00',
    '2017/11/01/09:00', '2017/11/16/09:00', '2017/12/01/09:00', '2017/12/16/09:00',

    '2018/01/01/09:00', '2018/01/16/09:00', '2018/02/01/09:00', '2018/02/16/09:00',
    '2018/03/01/09:00', '2018/03/16/09:00', '2018/04/01/09:00', '2018/04/16/09:00',
    '2018/05/01/09:00', '2018/05/16/09:00', '2018/06/01/09:00', '2018/06/16/09:00',
    '2018/07/01/09:00', '2018/07/16/09:00', '2018/08/01/09:00', '2018/08/16/09:00',
    '2018/09/01/09:00', '2018/09/16/09:00', '2018/10/01/09:00', '2018/10/16/09:00',
    '2018/11/01/09:00', '2018/11/16/09:00', '2018/12/01/09:00', '2018/12/16/09:00',

    '2019/01/01/09:00', '2019/01/16/09:00', '2019/02/01/09:00', '2019/02/16/09:00',
    '2019/03/01/09:00', '2019/03/16/09:00', '2019/04/01/09:00', '2019/04/16/09:00',
    '2019/05/01/09:00', '2019/05/16/09:00', '2019/06/01/09:00', '2019/06/16/09:00',
    '2019/07/01/09:00', '2019/07/16/09:00', '2019/08/01/09:00', '2019/08/16/09:00',
    '2019/09/01/09:00', '2019/09/16/09:00', '2019/10/01/09:00', '2019/10/16/09:00',
    '2019/11/01/09:00', '2019/11/16/09:00', '2019/12/01/09:00', '2019/12/16/09:00',

    '2020/01/01/09:00', '2020/01/16/09:00', '2020/02/01/09:00', '2020/02/16/09:00',
    '2020/03/01/09:00', '2020/03/16/09:00', '2020/04/01/09:00', '2020/04/16/09:00',
    '2020/05/01/09:00', '2020/05/16/09:00', '2020/06/01/09:00', '2020/06/16/09:00',
    '2020/07/01/09:00', '2020/07/16/09:00', '2020/08/01/09:00', '2020/08/16/09:00',
    '2020/09/01/09:00', '2020/09/16/09:00', '2020/10/01/09:00', '2020/10/16/09:00',
    '2020/11/01/09:00', '2020/11/16/09:00', '2020/12/01/09:00', '2020/12/16/09:00',

    '2021/01/01/09:00', '2021/01/16/09:00', '2021/02/01/09:00', '2021/02/16/09:00',
    '2021/03/01/09:00', '2021/03/16/09:00', '2021/04/01/09:00', '2021/04/16/09:00',
    '2021/05/01/09:00', '2021/05/16/09:00', '2021/06/01/09:00', '2021/06/16/09:00',
    '2021/07/01/09:00', '2021/07/16/09:00', '2021/08/01/09:00', '2021/08/16/09:00',
    '2021/09/01/09:00', '2021/09/16/09:00', '2021/10/01/09:00', '2021/10/16/09:00',
    '2021/11/01/09:00', '2021/11/16/09:00', '2021/12/01/09:00', '2021/12/16/09:00',
    '2022/01/01/09:00', '2022/01/16/09:00', '2022/02/01/09:00', '2022/02/16/09:00',
    '2022/03/01/09:00', '2022/03/16/09:00', '2022/04/01/09:00', '2022/04/16/09:00',


    '2022/05/01/09:00', '2022/05/16/09:00', '2022/06/01/09:00', '2022/06/16/09:00',
    '2022/07/01/09:00', '2022/07/16/09:00', '2022/08/01/09:00', '2022/08/16/09:00',
    '2022/09/01/09:00', '2022/09/16/09:00', '2022/10/01/09:00', '2022/10/16/09:00',
    '2022/11/01/09:00', '2022/11/16/09:00', '2022/12/01/09:00', '2022/12/16/09:00',

    '2023/01/01/09:00', '2023/01/16/09:00', '2023/02/01/09:00', '2023/02/16/09:00',
    '2023/03/01/09:00', '2023/03/16/09:00', '2023/04/01/09:00', '2023/04/16/09:00',
    '2023/05/01/09:00', '2023/05/16/09:00', '2023/06/01/09:00', '2023/06/16/09:00',
    '2023/07/01/09:00', '2023/07/16/09:00', '2023/08/01/09:00', '2023/08/16/09:00',
    '2023/09/01/09:00', '2023/09/16/09:00', '2023/10/01/09:00', '2023/10/16/09:00',
    '2023/11/01/09:00', '2023/11/16/09:00', '2023/12/01/09:00', '2023/12/16/09:00',
]

end_times = [
    '2017/01/15/15:00', '2017/01/31/15:00', '2017/02/15/15:00', '2017/02/28/15:00',
    '2017/03/15/15:00', '2017/03/31/15:00', '2017/04/15/15:00', '2017/04/30/15:00',
    '2017/05/15/15:00', '2017/05/31/15:00', '2017/06/15/15:00', '2017/06/30/15:00',
    '2017/07/15/15:00', '2017/07/31/15:00', '2017/08/15/15:00', '2017/08/31/15:00',
    '2017/09/15/15:00', '2017/09/30/15:00', '2017/10/15/15:00', '2017/10/31/15:00',
    '2017/11/15/15:00', '2017/11/30/15:00', '2017/12/15/15:00', '2017/12/31/15:00',

    '2018/01/15/15:00', '2018/01/31/15:00', '2018/02/15/15:00', '2018/02/28/15:00',
    '2018/03/15/15:00', '2018/03/31/15:00', '2018/04/15/15:00', '2018/04/30/15:00',
    '2018/05/15/15:00', '2018/05/31/15:00', '2018/06/15/15:00', '2018/06/30/15:00',
    '2018/07/15/15:00', '2018/07/31/15:00', '2018/08/15/15:00', '2018/08/31/15:00',
    '2018/09/15/15:00', '2018/09/30/15:00', '2018/10/15/15:00', '2018/10/31/15:00',
    '2018/11/15/15:00', '2018/11/30/15:00', '2018/12/15/15:00', '2018/12/31/15:00',

    '2019/01/15/15:00', '2019/01/31/15:00', '2019/02/15/15:00', '2019/02/28/15:00',
    '2019/03/15/15:00', '2019/03/31/15:00', '2019/04/15/15:00', '2019/04/30/15:00',
    '2019/05/15/15:00', '2019/05/31/15:00', '2019/06/15/15:00', '2019/06/30/15:00',
    '2019/07/15/15:00', '2019/07/31/15:00', '2019/08/15/15:00', '2019/08/31/15:00',
    '2019/09/15/15:00', '2019/09/30/15:00', '2019/10/15/15:00', '2019/10/31/15:00',
    '2019/11/15/15:00', '2019/11/30/15:00', '2019/12/15/15:00', '2019/12/31/15:00',

    '2020/01/15/15:00', '2020/01/31/15:00', '2020/02/15/15:00', '2020/02/28/15:00',
    '2020/03/15/15:00', '2020/03/31/15:00', '2020/04/15/15:00', '2020/04/30/15:00',
    '2020/05/15/15:00', '2020/05/31/15:00', '2020/06/15/15:00', '2020/06/30/15:00',
    '2020/07/15/15:00', '2020/07/31/15:00', '2020/08/15/15:00', '2020/08/31/15:00',
    '2020/09/15/15:00', '2020/09/30/15:00', '2020/10/15/15:00', '2020/10/31/15:00',
    '2020/11/15/15:00', '2020/11/30/15:00', '2020/12/15/15:00', '2020/12/31/15:00',

    '2021/01/15/15:00', '2021/01/31/15:00', '2021/02/15/15:00', '2021/02/28/15:00',
    '2021/03/15/15:00', '2021/03/31/15:00', '2021/04/15/15:00', '2021/04/30/15:00',
    '2021/05/15/15:00', '2021/05/31/15:00', '2021/06/15/15:00', '2021/06/30/15:00',
    '2021/07/15/15:00', '2021/07/31/15:00', '2021/08/15/15:00', '2021/08/31/15:00',
    '2021/09/15/15:00', '2021/09/30/15:00', '2021/10/15/15:00', '2021/10/31/15:00',
    '2021/11/15/15:00', '2021/11/30/15:00', '2021/12/15/15:00', '2021/12/31/15:00',

    '2022/01/15/15:00', '2022/01/31/15:00', '2022/02/15/15:00', '2022/02/28/15:00',
    '2022/03/15/15:00', '2022/03/31/15:00', '2022/04/15/15:00', '2022/04/30/15:00',
    '2022/05/15/15:00', '2022/05/31/15:00', '2022/06/15/15:00', '2022/06/30/15:00',
    '2022/07/15/15:00', '2022/07/31/15:00', '2022/08/15/15:00', '2022/08/31/15:00',
    '2022/09/15/15:00', '2022/09/30/15:00', '2022/10/15/15:00', '2022/10/31/15:00',
    '2022/11/15/15:00', '2022/11/30:15:00', '2022/12/15/15:00', '2022/12/31/15:00',

    '2023/01/15/15:00', '2023/01/31/15:00', '2023/02/15/15:00', '2023/02/28/15:00',
    '2023/03/15/15:00', '2023/03/31/15:00', '2023/04/15/15:00', '2023/04/30/15:00',
    '2023/05/15/15:00', '2023/05/31/15:00', '2023/06/15/15:00', '2023/06/30/15:00',
    '2023/07/15/15:00', '2023/07/31/15:00', '2023/08/15/15:00', '2023/08/31/15:00',
    '2023/09/15/15:00', '2023/09/30/15:00', '2023/10/15/15:00', '2023/10/31/15:00',
    '2023/11/15/15:00', '2023/11/22/15:00', '2023/12/15/15:00', '2023/12/31/15:00',
]

ep.trading_9h = False
ep.reinfo_th = 0.26
ep.model_reinfo_th = 0.26
ep.profit.loss_cut = 0.01
ep.pred_term = 6
ep.target_type = 'C'

import make_reinfo as mr
ep.mr = mr
ep.tm.mr = mr

start_time = '2023/01/01/09:00'
end_time = '2023/11/22/15:00'

start_index = start_times.index(start_time)
end_index = end_times.index(end_time)

last_trains = last_trains[start_index:end_index+1]
start_times = start_times[start_index:end_index+1]
end_times = end_times[start_index:end_index+1]

term = datetime.datetime.strptime(start_time, "%Y/%m/%d/%H:%M").strftime("%Y-%m-%d") + "~" + \
       datetime.datetime.strptime(end_time, "%Y/%m/%d/%H:%M").strftime("%Y-%m-%d") + "_" + \
       str(ep.pred_term) + ep.target_type + "_reinfo_" + str(ep.reinfo_th)

import os
folder = "best_ensemble/best_ensemble_" + term + "_losscut" + str(ep.profit.loss_cut)
if not os.path.isdir(folder):
    os.makedirs(folder)

def main():

    ensemble_models = ""
    for i in range(ep.selected_num):
        ensemble_models = ensemble_models + ep.ensembles[i] + "_"

    length = len(last_trains)

    if ep.trading_9h:
        path = "9시시가에거래_ensemble_" + str(ep.pred_term) + ep.target_type + "_" + "_reinfo_" + str(ep.reinfo_th) + \
               "_" + str(ep.model_reinfo_th) + "_losscut_" + str(ep.profit.loss_cut) + "_" + ensemble_models + ".xlsx"
    else:
        path = "9시거래없음_ensemble_" + str(ep.pred_term) + ep.target_type + "_" + "_reinfo_" + str(ep.reinfo_th) + \
               "_" + str(ep.model_reinfo_th) + "_losscut_" + str(ep.profit.loss_cut) + "_" + ensemble_models + ".xlsx"

    path = folder + "/" + path

    # 모델별 각 구간별 수익률 계산, 저장
    profit_sum = []
    profit_product = 1
    profits = np.empty(0)
    dates = np.empty(0)
    closes = np.empty(0)
    for i in range(len(last_trains)):
        ep.last_train = last_trains[i]
        ep.start_time = start_times[i]
        ep.end_time = end_times[i]

        ep.df_pred_path = ep.last_train + '/kospi200f_60M_pred.csv'
        ep.df_raw_path = ep.last_train + '/kospi200f_60M_raw.csv'
        ep.result_path = ep.last_train + '/pred_83_results.csv'

        ep.selected_checkpoint_path = ['' for i in range(ep.selected_num + 1)]
        for j in range(ep.selected_num):
            ep.selected_checkpoint_path[j] = ep.last_train + '/' + '60M_' + ep.ensembles[j] + '_best'

        ep.preprocessing()
        p = ep.predict()
        print(last_trains[i] + " 수익률: " + str(p))
        profit_sum.append(p)#max(p, 0.5)
        profit_product *= p#max(p, 0.5)

        df = pd.read_csv(ep.result_path, encoding='euc-kr')
        profit = df['profit'].values - df['fee'].values

        profits = np.concatenate([profits, profit], axis=0)
        dates = np.concatenate([dates, df['date'].values], axis=0)
        closes = np.concatenate([closes, df['close'].values], axis=0)

    profits_rates = profits.cumsum() / (closes.mean() * 250000 * 0.078) + 1#profits.cumsum() / 8000000 + 1
    close_rates = (np.array(closes) - closes[0]) / closes[0] / 0.078#(np.array(closes) - closes[0]) * 250000 / 8000000 + 1

    print("평균: ", np.array(profit_sum).mean())#str(profit_sum/len(last_trains)))
    print("복리누적: " + str(profit_product))
    print("profit_rate: " + str(profits_rates[-1]))

    return dates, closes, close_rates, profits, profits_rates, np.array(profit_sum).std(), profit_product, ensemble_models, path

def create_ensembles():
    result_path = "all_ensemble_results/all_ensemble_results_" + term + ".csv"
    columns = ['0', '1', '2', 'profit_rates', 'std', 'profit_product']

    models = ['5C', '5HL', '5P', '10C', '10HL', '10P', '15C', '15HL', '15P', '20C', '20HL', '20P',
              '25C', '25HL', '25P', '30C', '30HL', '30P', '40C', '40HL', '40P']

    cnt = 1330

    print(datetime.datetime.now())
    if os.path.isfile(result_path):
        results = pd.read_csv(result_path).values.tolist()
        total_ensembles = pd.read_csv(result_path).values[:, :3].tolist()
    else:
        results = []
        total_ensembles = []


    best = [0, '']

    for i in range(cnt):
        ensembles = random.sample(models, ep.selected_num)
        while sorted(ensembles) in total_ensembles:
            ensembles = random.sample(models, ep.selected_num)
        ensembles = sorted(ensembles)
        total_ensembles.append(ensembles)

        ep.ensembles = ensembles

        dates, closes, close_rates, profits, profits_rates, std, profit_product, ensemble_models, path = main()

        if profits_rates[-1] > best[0]:
            best[0] = profits_rates[-1]
            best[1] = ensemble_models

            dic = {'dates': dates, 'profits': profits, 'closes': closes, 'profit_rates': profits_rates}
            pd.DataFrame(dic).to_excel(path, index=False, encoding='euc-kr')

        print("best models: ", best)

        print(ensembles, profits_rates[-1], std, profit_product)
        results.append([ensembles[0], ensembles[1], ensembles[2], profits_rates[-1], std, profit_product])

        if i % 10 == 0:
            print("========================================================================")
            print(" ")
            print(i)
            print(" ")
            print("========================================================================")

        print(datetime.datetime.now())
        pd.DataFrame(np.array(results), columns=columns).drop_duplicates().to_csv(result_path, index=False, encoding='euc-kr')

    print(datetime.datetime.now())
    pd.DataFrame(np.array(results), columns=columns).drop_duplicates().to_csv(result_path, index=False, encoding='euc-kr')

    models = ['5C', '5HL', '5P', '10C', '10HL', '10P', '15C', '15HL', '15P', '20C', '20HL', '20P',
              '25C', '25HL', '25P', '30C', '30HL', '30P', '40C', '40HL', '40P']

    df = []

    selected_models = get_best_ensemble(path, models)
    print('best ensemble')
    print(selected_models)
    selected_models.append('kospi200f')
    df.append(selected_models)

    #pd.DataFrame(np.array((df))).to_csv("best_profit_avg_model_2022~2022-11-07.csv", index=False, encoding='euc-kr')

def get_best_ensemble(ensemble_path, models):
    selected_models = ["" for i in range(ep.selected_num)]
    df = pd.read_csv(ensemble_path, encoding='euc-kr')
    df = df.sort_values(df.columns[3], ascending=False)
    freq = [0 for i in range(len(models))]
    for i in range(10):
        for j in range(ep.selected_num):
            freq[models.index(df.values[i, j])] += 1
    for k in range(ep.selected_num):
        max_idx = np.argmax(np.array(freq))
        selected_models[k] = models[max_idx]
        freq[max_idx] = 0

    return selected_models

if __name__ == "__main__":
    create_ensembles()
    sys.exit(0)